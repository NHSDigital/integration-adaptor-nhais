# This is an OpenAPI Specification (https://swagger.io/specification/)
# for the NHAIS Adaptor API
# owned by NHS Digital (https://digital.nhs.uk/)
openapi: "3.0.0"
info:
  version: "0.1.0"
  title: GP Links - NHAIS Adaptor (FHIR) API
  description: |
      ## Overview
      Use this API to access the GP Links - NHAIS Adaptor API

      You can:
        * Accept a new patient
        * Amend an existing patient's demographics
        * Request a Removal for a patient who has moved out of area
        * Request a Deduction for a supported reason

      The GP Links - NHAIS Adaptor does not store any patient demographic data and does not support GET operations.

      The API is loosely based on the [Personal Demographics Service API](https://github.com/NHSDigital/personal-demographics-service-api)

      **PLEASE NOTE** - It is the responsibility of any GP IT system supplier implementing this adaptor to ensure that
      adequate validation is performed against ALL data items. There is no data validation or transformation performed by
      this adaptor for ANY transaction type.

      ## Technology
      This API is [RESTful](https://digital.nhs.uk/developer/developer-reference/introduction-to-apis#basic-rest).

      It also conforms to the [FHIR](https://digital.nhs.uk/developer/developer-reference/introduction-to-apis#fhir) global standard for health care data exchange.
      Specifically, it is aligned with [FHIR UK Core](https://digital.nhs.uk/services/fhir-uk-core), which is built on FHIR Release 4.

      You don’t need to know much about FHIR to use this API - FHIR APIs are just RESTful APIs that follow specific
      rules. In particular:
        - resource names are capitalised and singular, for example the `/Patient` not `/patients`
        - array names are singular, for example `line` not `lines` for address lines
        - data items that are country-specific and thus not included in the FHIR global base resources are usually wrapped in an `extension` object
        - data items related to an operation rather than the resource are represented as `Parameter`s

      ## Example Requests

      A number of example requests are available as part of the adaptor's user acceptance tests.

      The [Examples](https://github.com/nhsconnect/integration-adaptor-nhais/blob/develop/README.md#examples) section
      of the README explains these examples in further detail.

      ## Permitted Characters for Data Items

      Where the adaptor API represents a data item as a string the GP System **MUST** supply a value that complies
      with the NHAIS GP Links Specification. The requirements for each data item are described by Chapter 3 of the
      specification. For "free text" fields Chapter 3 refers to Appendix K.

      There are four characters which must be given special treatment. If used within a string-typed data item the
      following characters must be escaped (preceded) by a question mark: `' + : ?`

      For example, to represent the GP Note

          PATIENT'S + 1 : PATIENTS?

      the JSON request to the adaptor would include the parameter

          {
            "name": "freeText",
            "valueString": "PATIENT?'S ?+ 1 ?: PATIENTS??"
          }

      ## Terminology

      This specification follows the terminology used in Chapter 3 of the GP System Specification to describe the data
      items. Some data items that are referred to by different names both within the specification and across the
      NHS estate. This section aims to disambiguate some of these synonymous names, but it is not an exhaustive glossary
      of terminology.

      #### GP Code

      The GP Code is sometimes called the "Patient's Responsible GP Code". The GP Code is a combination of two values:

      > The GMC national GP code and the HA locally-defined GP code MUST both be sent, in the format GMC national GP code
      concatenated with a comma (,) concatenated with the HA local GP code.

      _Source: GP System Specification 4.3.7_

      The "GMC national GP Code" is also referred to as the "GMC National code" or simply the "GMC Code".

      The "HA local GP code" is also referred to as the "HA locally-defined GP code", "Local GP code" or "local code".
      Elsewhere in the NHS estate this value may be referred to as the "Partnership Code", "Practice Code", or most
      confusingly the "GP Code". If a practice is assigned different values for any of these then the operator of the
      NHAIS system should be consulted to determine which to use.
    
      > This is not the same the as the practice ODS code, and will be provided with by PCSE at the point that the link 
      is established. This is a Local Code of PCSE’s choosing.

      #### GP Trading Partner Code

      The GP Trading Partner Code is a four-character (uppercase letters and digits) code used in the interchange header
      of the EDIFACT messages. This may also be referred to as the "GP Link Code".
    
      > For English Practices, the supplier will be provided with this by PCSE (Primary Care Support England, Capita),
      the organisation that operates the 82 English NHAIS systems (+ the DMS NHAIS system), at the point that the link 
      is established. 
      This is a Local Code of PCSE’s choosing (3 alphas and a 5).
    
      #### Managing Organisation
    
      This is the Link Code of the NHAIS system, in the same way as GP Trading Partner Code is the Link Code for 
      the GP system (3 alphas and a 5).  This is the NHAIS System Cipher with either 1 or “01” on the end 
      – e.g. BE (Berkshire) is BE01, SHE (Sheffield) is SHE1. 
    
      > A 2 character Cipher has “01” on the end. 
      > A 3 character Cipher has “1” on the end.
    
      #### Destination HA Cipher

      The "Destination HA Cipher" is the identifier of the NHAIS instance of the patient's managing organisation. The
      identifier is comprised of two or three uppercase letters. It is also called the "Patient's Responsible HA" or
      simply referred to as "Cipher".

      > The cipher is related to the "HA Link Code": the four-character codes used to configure the environment variable
       NHAIS_MESH_RECIPIENT_MAILBOX_ID_MAPPINGS. Refer to the instructions for configuring this variable for more details.

      A full list of the available "HA Cipher" codes is available from the 
      [NHAIS Developer Document Library](https://digital.nhs.uk/services/nhais/nhais-developer-document-library).
      As this list is definitive and will not change before NHAIS is retired a copy has been stored as 
      ## Operation Id

      The adaptor includes in the response header of every successful request an OperationId value. The OperationId
      is generated from the GP Trading Partner Code and the Transaction Number. The series of OperationId values for a
      given GP Trading Partner Code repeats every 10,000,000 transactions.

      The GP MUST retain the OperationId from Acceptance transactions to match inbound Approvals and Rejections. The GP
      System SHOULD retain the OperationId for all other transactions.

  contact:
    name: National Integration Adaptors API Support
    url: 'https://github.com/nhsconnect/integration-adaptor-nhais'
servers:
  - url: 'https://localhost'
    description: There are no publicly available services available for testing or integration
tags:
  - name: patients
paths:
  '/fhir/Patient/$nhais.deduction':
    post:
      description: |
        ## Overview

        Use this endpoint to send a Deduction transaction to NHAIS.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3 for the complete requirements for deductions. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        | GP Links Data Item      | Deduction |
        |-------------------------|-----------|
        | GP Code                 | REQUIRED  |
        | GP Trading Partner Code | REQUIRED  |
        | Destinaton HA Cipher    | REQUIRED  |
        | NHS Number              | REQUIRED  |
        | Date of Deduction       | REQUIRED  |
        | Reason for Deduction    | REQUIRED  |
        | GP Notes                | OPTIONAL  |

        ## FHIR Field Mappings

        GP Links Specification Chapter 3.11.4 lists data fields and their requirements for out-going deduction requests.

        | Data Item                 | FHIR Resource | Patient JSON Pointer or Parameter Name   | Parameter Value Property | Format, if different from GP Links | Notes                                      |
        |---------------------------|---------------|------------------------------------------|--------------------------|------------------------------------|--------------------------------------------|
        | Transaction Type          | N/A           | N/A                                      | N/A                      | N/A                                | Usage of the $nhais.deduction operation on the Patient resource indicates the transaction type
        | GP Code                   | Patient       | /generalPractitioner/0/identifier/value  |                          |                                    |                                            |
        | GP Trading Partner Code   | Parameter     | gpTradingPartnerCode                     | valueString              |                                    |                                            |
        | Destinaton HA Cipher      | Patient       | /managingOrganization/identifier/0/value |                          |                                    |                                            |
        | Transaction Date and Time | N/A           | N/A                                      | N/A                      | N/A                                | Managed by the adaptor
        | Transaction Number        | N/A           | N/A                                      | N/A                      | N/A                                | Managed by the adaptor
        | NHS Number                | Patient       | /identifier/0/value                      |                          |                                    |                                            |
        | Date of Deduction         | Parameter     | dateOfDeduction                          | valueString              | ISO 8601 Date                      |                                            |
        | Reason for Deduction      | Parameter     | deductionReasonCode                      | valueString              |                                    | Refer to Chapter 3 / Appendix G for possible values
        | GP Notes                  | Parameter     | freeText                                 | valueString              |                                    |                                            |

      summary: Deduct a patient (Deduction transaction)
      parameters:
        - in: header
          name: ConversationId
          required: false
          description: (Optional) a unique identifier to trace this request in logs and databases
          schema:
            type: string
      operationId: deduction
      tags:
        - patients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The deduction is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: This identifier for the operation SHOULD be retained for logging and tracing
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
        default:
          description: The request could not be processed and forwarded to NHAIS
          headers:
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
              examples:
                bad-request:
                  summary: The request payload is invalid
                  value:
                    $ref: components/examples/responses/400-bad-request.json
  '/fhir/Patient/$nhais.removal':
    post:
      description: |
        ## Status

        This endpoint is not implemented yet and the design is incomplete. The specification is expected to change.

        ## Overview

        Use this endpoint to send a Removal transaction to NHAIS.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3 for the complete requirements for removals. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        | GP Links Data Item      | Removal  |
        |-------------------------|----------|
        | GP Code                 | REQUIRED |
        | GP Trading Partner Code | REQUIRED |
        | Destinaton HA Cipher    | REQUIRED |
        | NHS Number              | REQUIRED |
        | Reason for Removal      | REQUIRED |

        ## FHIR Field Mappings

        GP Links Specification Chapter 3.9.4 lists data fields and their requirements for out-going removal transactions.

        | Data Item                 | FHIR Resource | Patient JSON Pointer or Parameter Name   | Parameter Value Property | Format, if different from GP Links | Notes                         |
        |---------------------------|---------------|------------------------------------------|--------------------------|------------------------------------|-------------------------------|
        | Transaction Type          | N/A           | N/A                                      | N/A                      | N/A                                | Usage of the $nhais.removal operation on the Patient resource indicates the transaction type
        | GP Code                   | Patient       | /generalPractitioner/0/identifier/value  |                          |                                    |
        | GP Trading Partner Code   | Parameter     | gpTradingPartnerCode                     | valueString              |                                    |
        | Destinaton HA Cipher      | Patient       | /managingOrganization/identifier/0/value |                          |                                    |
        | Transaction Date and Time | N/A           | N/A                                      | N/A                      | N/A                                | Managed by the adaptor
        | Transaction Number        | N/A           | N/A                                      | N/A                      | N/A                                | Managed by the adaptor
        | NHS Number                | Patient       | /identifier/0/value                      |                          |                                    |
        | Reason for Removal        | Parameter     | freeText                                 | valueString              |                                    |

      summary: Removal (Out of Area)
      parameters:
        - in: header
          name: ConversationId
          required: false
          description: (Optional) a unique identifier to trace this request in logs and databases
          schema:
            type: string
      operationId: removal
      tags:
        - patients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The removal is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: This identifier for the operation SHOULD be retained for logging and tracing
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
        default:
          description: The request could not be processed and forwarded to NHAIS
          headers:
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
  '/fhir/Patient/$nhais.acceptance':
    post:
      description: |
        ## Status

        ## Overview
        Use this endpoint to send an Acceptance to NHAIS.

        ## Supported Acceptance Types

        * Type 1 - Birth
        * Type 2 - First Acceptance
        * Type 3 - Transfer In
        * Type 4 - Immigrant

        Type 5 - Ex-Services is no longer used. Such patients are now registered as Type 3 - Transfer In.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3 for the complete requirements for manually-entered acceptances. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        The following fields are OBSOLETE and not supported by the adaptor:

        * RPP Mileage
        * Blocked Route/Special District Marker
        * Walking Units
        * Date of Enlistment (Joining)
        * Date of Enlistment (Leaving)
        * Service Dependant Marker

        REQUIRED - If any of these data items are not provided or are blank then the adaptor will produce a 400 error
        OPTIONAL - These data items may be included if available
        OBSOLETE - The adaptor provides no FHIR representation for these items and it is not possible to include them
        NOT REQUIRED - These data items are will be ignored if provided

        Any other values not listed in the tables below and provided in the request that are valid for a FHIR R4
        Parameter or Patient resource will be ignored.

        | Data Item                             | Type 1 - Birth | Type 2 - First | Type 3 - Transfer In | Type 4 - Immigrant |
        |---------------------------------------|----------------|----------------|----------------------|--------------------|
        | Date of Acceptance                    | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Acceptance Type                       | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Acceptance Code                       | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | GP Code (Patient's Responsible GP)    | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | GP Trading Partner Code               | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Destionation HA Cipher                | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | NHS Number                            | REQUIRED       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Surname                               | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Previous Surname                      | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | First Forename                        | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Second Forename                       | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Other Forenames                       | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Title                                 | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Sex                                   | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Date of Birth                         | REQUIRED       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Address excluding Postcode            | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Address - Postcode                    | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Place of Birth                        | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Drugs Dispensed Marker                | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Residential Institute Code            | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | GP Notes (Free Text)                  | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Previous Address - 5 fields           | NOT REQUIRED   | NOT REQUIRED   | REQUIRED             | OPTIONAL           |
        | Previous GP Name                      | NOT REQUIRED   | NOT REQUIRED   | REQUIRED             | OPTIONAL           |
        | Previous HA Cipher                    | NOT REQUIRED   | NOT REQUIRED   | OPTIONAL             | OPTIONAL           |
        | Date of Entry into UK                 | NOT REQUIRED   | NOT REQUIRED   | NOT REQUIRED         | REQUIRED           |
        | Date of Exit from UK                  | NOT REQUIRED   | NOT REQUIRED   | NOT REQUIRED         | OPTIONAL           |
        | RPP Mileage                           | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |
        | Blocked Route/Special District Marker | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |
        | Walking Units                         | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |
        | Date of Enlistment (Joining)          | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |
        | Date of Enlistment (Leaving)          | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |
        | Service Dependant Marker              | OBSOLETE       | OBSOLETE       | OBSOLETE             | OBSOLETE           |

        ## FHIR Field Mappings

        GP Links Specification Chapter 3.3.4 lists data fields and their requirements for out-going acceptance transactions.

        | Data Item                             | FHIR Resource | Patient JSON Pointer or Parameter Name   | Parameter Value Property | Format, if different from GP Links    | Notes                                                                                               |
        |---------------------------------------|---------------|------------------------------------------|--------------------------|---------------------------------------|-----------------------------------------------------------------------------------------------------|
        | Transaction Type                      | N/A           | N/A                                      | N/A                      | N/A                                   | Usage of the $nhais.acceptance operation on the Patient resource indicates the transaction type
        | GP Code (Patient's Responsible GP)    | Patient       | /generalPractitioner/0/identifier/value  |                          | See GP System Specification 4.3.7     |                                                                                                     |
        | GP Trading Partner Code               | Parameter     | gpTradingPartnerCode                     | valueString              |                                       |                                                                                                     |
        | Destination HA Cipher                 | Patient       | /managingOrganization/identifier/0/value |                          |                                       |                                                                                                     |
        | Transaction Date and Time             | N/A           | N/A                                      | N/A                      | N/A                                   | Managed by the adaptor
        | Transaction Number                    | N/A           | N/A                                      | N/A                      | N/A                                   | Managed by the adaptor
        | Acceptance Type                       | Parameter     | acceptanceType                           | valueString              |                                       |                                                                                                     |
        | NHS Number                            | Patient       | /identifier/0/value                      |                          |                                       |                                                                                                     |
        | Surname                               | Patient       | /name/0/family                           |                          |                                       |                                                                                                     |
        | First Forename                        | Patient       | /name/0/given/0                          |                          |                                       |                                                                                                     |
        | Second Forename                       | Patient       | /name/0/given/1                          |                          |                                       |                                                                                                     |
        | Other Forenames                       | Patient       | /name/0/given/2                          |                          |                                       |                                                                                                     |
        | Previous Surname                      | Patient       | /name/1/family                           |                          |                                       |                                                                                                     |
        | Title                                 | Patient       | /name/0/prefix/0                         |                          |                                       |                                                                                                     |
        | Sex                                   | Patient       | /gender                                  |                          | male/female/unknown/other             |                                                                                                     |
        | Date of Birth                         | Patient       | /birthDate                               |                          | ISO 8601 Date                         |                                                                                                     |
        | Address - House Name                  | Patient       | /address/0/line/0                        |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Address - Number / Road Name          | Patient       | /address/0/line/1                        |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Address - Locality                    | Patient       | /address/0/line/2                        |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Address - Post Town                   | Patient       | /address/0/line/3                        |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Address - County                      | Patient       | /address/0/line/4                        |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Address - Postcode                    | Patient       | /address/0/postalCode                    |                          |                                       |                                                                                                     |
        | Drugs Dispensed Marker                | Patient       | /extension/0/valueBoolean                |                          | true/false                            | "url": "https://fhir.nhs.uk/R4/StructureDefinition/Extension-UKCore-NHAIS-DrugsDispensedMarker"     |
        | RPP Mileage                           | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Blocked Route/Special District Marker | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Walking Units                         | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Residential Institute Code            | Patient       | /extension/0/valueString                 |                          |                                       | "url": "https://fhir.nhs.uk/R4/StructureDefinition/Extension-UKCore-NHAIS-ResidentialInstituteCode" |
        | Place of Birth                        | Patient       | /extension/0/valueString                 |                          |                                       | "url": "http://hl7.org/fhir/StructureDefinition/patient-birthPlace"                                 |
        | Date of Acceptance                    | Parameter     | acceptanceDate                           | valueString              | ISO 8601 Date                         |                                                                                                     |
        | Date of Entry into UK                 | Parameter     | dateOfUkEntry                            | valueString              | ISO 8601 Date                         |                                                                                                     |
        | Date of Exit from UK                  | Parameter     | dateOfUkExit                             | valueString              | ISO 8601 Date                         |                                                                                                     |
        | Previous Address - 5 fields           | Patient       | /address/1/line/0-4                      |                          | Use JSON null for blank address lines | All 5 lines required but some may be null                                                           |
        | Previous GP Name                      | Parameter     | previousGpName                           | valueString              |                                       |                                                                                                     |
        | Previous HA Cipher                    | Parameter     | previousHaCipher                         | valueString              |                                       |                                                                                                     |
        | Date of Enlistment (Joining)          | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Date of Enlistment (Leaving)          | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Service Dependant Marker              | N/A           | N/A                                      | N/A                      | N/A                                   | Obsolete data fields are not mapped
        | Acceptance Code                       | Parameter     | acceptanceCode                           | valueString              |                                       |                                                                                                     |
        | GP Notes (Free Text)                  | Parameter     | freeText                                 | valueString              |                                       |                                                                                                     |

      summary: Accept a new patient (Acceptance transaction)
      parameters:
        - in: header
          name: ConversationId
          required: false
          description: (Optional) a unique identifier to trace this request in logs and databases
          schema:
            type: string
      operationId: acceptance
      tags:
        - patients
      requestBody:
        required: true
        description: "[HL7 FHIR R4 Parameters Resource](https://www.hl7.org/fhir/parameters.html)"
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The acceptance is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: This identifier for the operation MUST be retained to match the inbound reply
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
        default:
          description: The request could not be processed and forwarded to NHAIS
          headers:
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
              examples:
                bad-request:
                  summary: The request payload is invalid
                  value:
                    $ref: components/examples/responses/400-bad-request.json
  '/fhir/Patient/{nhsNumber}':
    parameters:
      - $ref: '#/components/parameters/Id'
    patch:
      description: |
        ## Overview
        Use this endpoint to send an Amendment to NHAIS.

        This is a 'patch' operation, meaning you can update specific parts of the patient record (such as a name or an address),
        as opposed to having to update the entire record.

        The adaptor is not a FHIR server and cannot perform actual patches onto Patient resources. Instead the patches are
        translated into an equivalent EDIFACT message. This places some restrictions on the patches accepted by the adaptor:

        * The value of "path" must match exactly those listed in the "FHIR / JSONPatch Field Mappings" table below. Logically
          equivalent alternatives are not permitted.
        * The only supported operations are add, replace, and remove
        * The add and replace operations are synonymous for GP Links
        * The GP System must only use remove operations for data items for which GP Links permits removal
        * With the exceptions of Drugs Dispensed Marker and Residential Institute Code, the GP System must use remove
          operations to erase an existing value. Performing an add or replace with an empty or null value will not work.
        * Each path most only be used once within the amendment request. It is not possible to, for example, perform a
          remove and an add on the same path within the same request.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3.5 for the complete requirements for manually-entered amendments. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        Three fields are obsolete and not supported by the adaptor:

        * RPP Mileage
        * Blocked Route/Special District Marker
        * Walking Units

        | GP Links Data Item                        | Amendment  | Erasable |
        |-------------------------------------------|------------|----------|
        | Existing GP Code                          | REQUIRED   | n/a      |
        | GP Trading Partner Code                   | REQUIRED   | n/a      |
        | Destination HA Cipher                     | REQUIRED   | n/a      |
        | NHS Number                                | REQUIRED   | n/a      |
        | New Surname                               | OPTIONAL   | NO       |
        | New Previous Surname                      | OPTIONAL   | YES      |
        | New First Forename                        | OPTIONAL   | YES (1)  |
        | New Second Forename                       | OPTIONAL   | YES (1)  |
        | New Other Forenames                       | OPTIONAL   | YES (1)  |
        | New Title                                 | OPTIONAL   | YES      |
        | New Sex                                   | OPTIONAL   | NO       |
        | New Date of Birth                         | OPTIONAL   | NO       |
        | New Address - House Name                  | OPTIONAL   | YES      |
        | New Address - Number/Road Name            | OPTIONAL   | YES      |
        | New Address - Locality                    | OPTIONAL   | YES      |
        | New Address - Post Town                   | OPTIONAL   | NO       |
        | New Address - County                      | OPTIONAL   | YES      |
        | New Address - Postcode                    | OPTIONAL   | YES      |
        | New Drugs Dispensed Marker                | OPTIONAL   | YES (2)  |
        | New Residential Institute Code            | OPTIONAL   | YES (3)  |
        | GP Notes                                  | OPTIONAL   | n/a      |

        (1) Forenames cannot be erased individually. The entire group of forenames must be erased instead.

        (2) The Drugs Dispensed Marker is "erased" by settings its value to false

        (3) The Residential Institute Code is "erased" by using an add/replace operation with "valueString" JSON value of null

        ## FHIR / JSONPatch Field Mappings

        GP Links Specification Chapter 3.5.4 lists data fields and their requirements for out-going manually
        entered amendments.

        | Data Field                                | Property Name        | JSONPatch "path" value                   | "value" format, if different from GP Links | Notes                                                                    |
        |-------------------------------------------|----------------------|------------------------------------------|--------------------------------------------|--------------------------------------------------------------------------|
        | Transaction Type                          | N/A                  | N/A                                      |                                            | Usage of the FHIR PATCH operation on the Patient resource indicates the transaction type
        | Existing GP Code                          | gpCode               |                                          |                                            |
        | GP Trading Partner Code                   | gpTradingPartnerCode |                                          |                                            |
        | Destination HA Cipher                     | healthcarePartyCode  |                                          |                                            | Same value as the managing organisation identifier in an acceptance
        | Transaction Date and Time                 | N/A                  | N/A                                      |                                            | Managed by the adaptor
        | Transaction Number                        | N/A                  | N/A                                      |                                            | Managed by the adaptor
        | NHS Number                                | nhsNumber            |                                          |                                            |
        | New Surname                               |                      | /name/0/family                           |                                            |
        | New First Forename                        |                      | /name/0/given/0 For remove: name/0/given |                                            | Forenames cannot be erased individually
        | New Second Forename                       |                      | /name/0/given/1 For remove: name/0/given |                                            | Forenames cannot be erased individually
        | New Other Forenames                       |                      | /name/0/given/2 For remove: name/0/given |                                            | Forenames cannot be erased individually
        | New Previous Surname                      |                      | /name/1/family                           |                                            |
        | New Title                                 |                      | /name/0/prefix/0                         |                                            |
        | New Sex                                   |                      | /gender                                  | male/female/unknown/other                  |
        | New Date of Birth                         |                      | /birthDate                               | ISO 8601 Date                              |
        | New Address - House Name                  |                      | /address/0/line/0                        | (3)                                        | If any address line is changed then patches for all 5 lines are required
        | New Address - Number/Road Name            |                      | /address/0/line/1                        | (3)                                        | If any address line is changed then patches for all 5 lines are required
        | New Address - Locality                    |                      | /address/0/line/2                        | (3)                                        | If any address line is changed then patches for all 5 lines are required
        | New Address - Post Town                   |                      | /address/0/line/3                        | (3)                                        | If any address line is changed then patches for all 5 lines are required
        | New Address - County                      |                      | /address/0/line/4                        | (3)                                        | If any address line is changed then patches for all 5 lines are required
        | New Address - Postcode                    |                      | /address/0/postalCode                    |                                            |
        | New Drugs Dispensed Marker                |                      | /extension/0                             | (1)                                        | The value 'false' erases the Drugs Dispensed Marker
        | New RPP Mileage                           | N/A                  | N/A                                      |                                            | Obsolete data fields are not mapped
        | New Blocked Route/Special District Marker | N/A                  | N/A                                      |                                            | Obsolete data fields are not mapped
        | Walking Units                             | N/A                  | N/A                                      |                                            | Obsolete data fields are not mapped
        | Residential Institute Code                |                      | /extension/0                             | (2)                                        | The value 'null' erases the Residential Institute Code                   |
        | GP Notes                                  | freeText             |                                          |                                            |

        (1) The `value` of the patch must be the entire extension including `url` and `valueBoolean` properties.

        (2) The `value` of the patch must be the entire extension including `url` and `valueString` properties.

        (3) Use JSON null for blank address lines. Either the "House Name" or the "Number/Road Name" MUST be present.

      summary: Amend patient details (Amendment transaction)
      parameters:
        - in: header
          name: ConversationId
          required: false
          description: (Optional) a unique identifier to trace this request in logs and databases
          schema:
            type: string
      operationId: amendment
      tags:
        - patients
      externalDocs:
        description: IETF RFC 6902, which defines json-patch.
        url: https://tools.ietf.org/html/rfc6902
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Amendment.yaml
      responses:
        '202':
          description: Amendment forwarded to NHAIS for processing
          headers:
            operationid:
              schema:
                type: string
              description: This identifier for the operation SHOULD be retained for logging and tracing
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
        default:
          description: The request could not be processed and forwarded to NHAIS
          headers:
            ConversationId:
              description: If a ConversationId request header is provided this will be the same value. Otherwise this is the ConversationId generated for the request.
              schema:
                type: string
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
              examples:
                bad-request:
                  summary: The request payload is invalid
                  value:
                    $ref: components/examples/responses/400-bad-request.json
components:
  parameters:
    Id:
      name: nhsNumber
      in: path
      description: The patient's NHS Number. The primary identifier of a patient, unique within NHS England and Wales. Always 10 digits and must be a [valid NHS Number](https://www.datadictionary.nhs.uk/data_dictionary/attributes/n/nhs/nhs_number_de.asp).
      required: true
      schema:
        type: string
        example: "9000000009"