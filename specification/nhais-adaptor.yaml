# This is an OpenAPI Specification (https://swagger.io/specification/)
# for the NHAIS Adaptor API
# owned by NHS Digital (https://digital.nhs.uk/)
openapi: "3.0.0"
info:
  version: "0.1.0"
  title: GP Links - NHAIS Adaptor (FHIR) API
  description: |
    ## Overview
    Use this API to access the GP Links - NHAIS Adaptor API

    You can:
    * Accept a new patient
    * Amend an existing patient's demographics
    * Request a Removal for a patient who has moved out of area
    * Request a Deduction for a supported reason

    The GP Links - NHAIS Adaptor does not store any patient demograpic data and no GET operations are supported.

    The API is based on the [Personal Demographics Service API](https://github.com/NHSDigital/personal-demographics-service-api)

    ## Technology
    This API is [RESTful](https://digital.nhs.uk/developer/developer-reference/introduction-to-apis#basic-rest).

    It also conforms to the [FHIR](https://digital.nhs.uk/developer/developer-reference/introduction-to-apis#fhir) global standard for health care data exchange.
    Specifically, it is aligned with [FHIR UK Core](https://digital.nhs.uk/services/fhir-uk-core), which is built on FHIR Release 4.

    You donâ€™t need to know much about FHIR to use this API - FHIR APIs are just RESTful APIs that follow specific rules.
    In particular:
    - resource names are capitalised and singular, for example the `/Patient` not `/patients`
    - array names are singular, for example `line` not `lines` for address lines
    - data items that are country-specific and thus not included in the FHIR global base resources are usually wrapped in an `extension` object
    - data items related to an operation rather than the resource are represented as `Parameter`s

    ## Example Requests

    A number of example requests are available as part of the adaptor's user acceptance tests.

    The [Examples](https://github.com/nhsconnect/integration-adaptor-nhais/blob/develop/README.md#examples) section
    of the README explains these examples in further detail.

  contact:
    name: National Integration Adaptors API Support
    url: 'https://github.com/nhsconnect/integration-adaptor-nhais'
servers:
  - url: 'https://localhost'
    description: There are no publicly available services available for testing or integration
tags:
  - name: patients
paths:
  '/fhir/Patient/{id}/$nhais.deduction':
    parameters:
      - $ref: '#/components/parameters/Id'
    post:
      description: |
        ## Status

        This endpoint is not implemented yet and the design is incomplete. The specification is expected to change.

        ## Overview

        Use this endpoint to send a Deduction transaction to NHAIS.

        ## Operation Id

        When you submit an amendment an operation id will be included in the response. This operation id MUST be retained
        to match against the asynchronous reply from NHAIS

        ## Payload Description

        The request payload is a Parameters list. The list must contain parameters with the following names and values:

        * `patient`: Patient `resource` containing id, generalPractitioner, and managingOrganization
        * `deductionReason`: simple parameter with `valueString` one of: death, emigrated, other
        * `deductionDate`: simple parameter with `valueDate` the date (no time) of the deduction in ISO format
        * `freeText`: simple parameter with `valueString` a brief, free-text reason for the deduction

      summary: Deduct a patient (Deduction transaction)
      operationId: deduction
      tags:
        - patients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The deduction is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: The unique identifier for the operation MUST be retained to match to the inbound reply
        '400':
          description: Bad Request - The request could not be processed and forwarded to NHAIS
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
  '/fhir/Patient/{id}/$nhais.removal':
    parameters:
      - $ref: '#/components/parameters/Id'
    post:
      description: |
        ## Status

        This endpoint is not implemented yet and the design is incomplete. The specification is expected to change.

        ## Overview

        Use this endpoint to send a Removal (Out of Area) transaction to NHAIS.

        ## Payload Description

        The request payload is a Parameters list with the following parameters:

        * patient: Patient `resource` containing id, generalPractitioner, and managingOrganization
        * freeText: simple parameter with `valueString` a brief, free-text reason for the removal

      summary: Removal (Out of Area)
      operationId: removal
      tags:
        - patients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The removal is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: The unique identifier for the operation MUST be retained to match to the inbound reply
        '400':
          description: Bad Request - The request could not be processed and forwarded to NHAIS
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
  '/fhir/Patient/$nhais.acceptance':
    post:
      description: |
        ## Status

        **Version 0.1.0**: Only data items marked REQUIRED are supported for translation to EDIFACT. Optional data items
        are accepted by the API but not translated into EDIFACT.

        ## Overview
        Use this endpoint to send an Acceptance to NHAIS.

        ## Supported Acceptance Types

        * Type 1 - Birth
        * Type 2 - First Acceptance
        * Type 3 - Transfer In
        * Type 4 - Immigrant

        Type 5 - Ex-Services is no longer used. Such patients are now registered as Type 3 - Transfer In.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3 for the complete requirements for mantually-entered acceptances. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        Three fields are deprecated and not supported by the adaptor:

        * RPP Mileage
        * Blocked Route/Special District Marker
        * Walking Units

        | Data Item                             | Type 1 - Birth | Type 2 - First | Type 3 - Transfer In | Type 4 - Immigrant |
        |---------------------------------------|----------------|----------------|----------------------|--------------------|
        | Acceptance Date                       | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Acceptance Type                       | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Acceptance Code                       | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Patient's Responsible GP (GMC Code)   | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | GP Trading Partner Code               | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Patient's Responsible HA              | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | NHS Number                            | REQUIRED       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Surname                               | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Previous Surname                      | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | First Forename                        | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Second Forename                       | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Other Forenames                       | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Title                                 | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Sex                                   | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Date of Birth                         | REQUIRED       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Present Address excluding Postcode    | REQUIRED       | REQUIRED       | REQUIRED             | REQUIRED           |
        | Present Address - Postcode            | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Place of Birth                        | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Drugs Dispensed Marker                | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | RPP Mileage                           | DEPRECATED     | DEPRECATED     | DEPRECATED           | DEPRECATED         |
        | Blocked Route/Special District Marker | DEPRECATED     | DEPRECATED     | DEPRECATED           | DEPRECATED         |
        | Walking Units                         | DEPRECATED     | DEPRECATED     | DEPRECATED           | DEPRECATED         |
        | Residential Institute Code            | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Free Text (GP Notes)                  | OPTIONAL       | OPTIONAL       | OPTIONAL             | OPTIONAL           |
        | Previous Address - 5 fields           | NOT PERMITTED  | NOT PERMITTED  | REQUIRED             | OPTIONAL           |
        | Previous GP Name                      | NOT PERMITTED  | NOT PERMITTED  | REQUIRED             | OPTIONAL           |
        | Previous HA Cipher                    | NOT PERMITTED  | NOT PERMITTED  | OPTIONAL             | OPTIONAL           |
        | Date of Entry into the UK             | NOT PERMITTED  | NOT PERMITTED  | NOT PERMITTED        | REQUIRED           |
        | Date Patient left the UK              | NOT PERMITTED  | NOT PERMITTED  | NOT PERMITTED        | OPTIONAL           |

        ## FHIR Field Mappings

        | Data Item                             | FHIR Resource | Patient JSON Pointer or Parameter Name   | Parameter Value Property | Format, if different from GP Links | Notes                                                                                               |
        |---------------------------------------|---------------|------------------------------------------|--------------------------|------------------------------------|-----------------------------------------------------------------------------------------------------|
        | Acceptance Date                       | Parameter     | acceptanceDate                           | valueString              | ISO 8601 Date                      |                                                                                                     |
        | Acceptance Type                       | Parameter     | acceptanceType                           | valueString              |                                    |                                                                                                     |
        | Acceptance Code                       | Parameter     | acceptanceCode                           | valueString              |                                    |                                                                                                     |
        | Patient's Responsible GP (GMC Code)   | Patient       | /generalPractitioner/0/identifier/value  |                          |                                    |                                                                                                     |
        | GP Trading Partner Code               | Parameter     | gpTradingPartnerCode                     | valueString              |                                    |                                                                                                     |
        | Patient's Responsible HA              | Patient       | /managingOrganization/identifier/0/value |                          |                                    |                                                                                                     |
        | NHS Number                            | Patient       | /identifier/0/value                      |                          |                                    |                                                                                                     |
        | Surname                               | Patient       | /name/0/family                           |                          |                                    |                                                                                                     |
        | Previous Surname                      | Patient       | /name/1/family                           |                          |                                    |                                                                                                     |
        | First Forename                        | Patient       | /name/0/given/0                          |                          |                                    |                                                                                                     |
        | Second Forename                       | Patient       | /name/0/given/1                          |                          |                                    |                                                                                                     |
        | Other Forenames                       | Patient       | /name/0/given/2                          |                          |                                    |                                                                                                     |
        | Title                                 | Patient       | /name/0/prefix/0                         |                          |                                    |                                                                                                     |
        | Sex                                   | Patient       | /gender                                  |                          | male/female/unknown/other          |                                                                                                     |
        | Date of Birth                         | Patient       | /birthDate                               |                          | ISO 8601 Date                      |                                                                                                     |
        | Present Address excluding Postcode    | Patient       | /address/0/line/0-4                      |                          | Use JSON null for empty/no value   | All 5 lines required                                                                                |
        | Present Address - Postcode            | Patient       | /address/0/postalCode                    |                          |                                    | "use": "home"                                                                                       |
        | Place of Birth                        | Patient       | /extension/0/valueString                 |                          |                                    | "url": "http://hl7.org/fhir/StructureDefinition/patient-birthPlace"                                 |
        | Drugs Dispensed Marker                | Patient       | /extension/0/valueBoolean                |                          | true/false                         | "url": "https://fhir.nhs.uk/R4/StructureDefinition/Extension-UKCore-NHAIS-DrugsDispensedMarker"     |
        | RPP Mileage                           | N/A           |                                          |                          |                                    |                                                                                                     |
        | Blocked Route/Special District Marker | N/A           |                                          |                          |                                    |                                                                                                     |
        | Walking Units                         | N/A           |                                          |                          |                                    |                                                                                                     |
        | Residential Institute Code            | Patient       | /extension/0/valueString                 |                          |                                    | "url": "https://fhir.nhs.uk/R4/StructureDefinition/Extension-UKCore-NHAIS-ResidentialInstituteCode" |
        | Free Text (GP Notes)                  | Parameter     | freeText                                 | valueString              |                                    |                                                                                                     |
        | Previous Address - 5 fields           | Patient       | /address/1/line/0-4                      |                          | Use JSON null for empty/no value   | All 5 lines required                                                                                |
        | Previous GP Name                      | Parameter     | previousGPName                           | valueString              |                                    |                                                                                                     |
        | Previous HA Cipher                    | Parameter     | previousHACipher                         | valueString              |                                    |                                                                                                     |
        | Date of Entry into the UK             | Parameter     | dateOfUkEntry                            | valueString              | ISO 8601 Date                      |                                                                                                     |
        | Date Patient left the UK              | Parameter     | dateOfUkExit                             | valueString              | ISO 8601 Date                      |                                                                                                     |

        ## Operation Id
        When you submit an amendment an operation id will be included in the response. This operation id MUST be retained
        to match against the asynchronous reply from NHAIS

      summary: Accept a new patient (Acceptance transaction)
      operationId: acceptance
      tags:
        - patients
      requestBody:
        required: true
        description: "[HL7 FHIR R4 Parameters Resource](https://www.hl7.org/fhir/parameters.html)"
        content:
          application/json:
            schema:
              $ref: components/schemas/Parameters.yaml
      responses:
        '202':
          description: The acceptance is forwarded to NHAIS for processing. The response body is empty.
          headers:
            operationid:
              schema:
                type: string
              description: The unique identifier for the operation MUST be retained to match to the inbound reply
        '400':
          description: Client error.
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
              examples:
                bad-request:
                  summary: The request payload is invalid
                  value:
                    $ref: components/examples/responses/400-bad-request.json
  '/fhir/Patient/{id}':
    parameters:
      - $ref: '#/components/parameters/Id'
    patch:
      description: |
        ## Status

        This endpoint is not implemented yet. The design is complete but some changes to specification may still be required.

        ## Overview
        Use this endpoint to send an Amendment to NHAIS.

        This is a 'patch' operation, meaning you can update specific parts of the patient record (such as a name or an address),
        as opposed to having to update the entire record.

        The adaptor is not a FHIR server and cannot perform actual patches onto Patient resources. Instead the patches are
        translated into an equivalent EDIFACT message. This places some restrictions on the patches accepted by the adaptor:

        * The value of "path" must match exactly those listed in the "FHIR / JSONPatch Field Mappings" table below. Logically
          equivalent alternatives are not permitted.
        * The only supported operations are add, replace, and remove
        * The add and replace operations are synonymous for GP Links
        * The GP System must only use remove operations for data items for which GP Links permits removal
        * With the exceptions of Drugs Dispensed Marker and Residential Institute Code, the GP System must use remove
          operations to erase an existing value. Performing an add or replace with an empty or null value will not work.
        * Each path most only be used once within the amendment request. It is not possible to, for example, perform a
          remove and an add on the same path within the same request.

        ## Supported Fields

        Refer to GP Links Specification Chapter 3.5 for the complete requirements for manually-entered amendments. The
        values sent to the adaptor must comply with the GP Links Specification and FHSREG:0:1:FH:FHS001.

        https://digital.nhs.uk/services/nhais/guide-to-nhais-gp-links-documentation

        Three fields are deprecated and not supported by the adaptor:

        * RPP Mileage
        * Blocked Route/Special District Marker
        * Walking Units

        | GP Links Data Item                        | Amendment  | Erasable |
        |-------------------------------------------|------------|----------|
        | Transaction Type                          | REQUIRED   | n/a      |
        | Existing GP Code                          | REQUIRED   | n/a      |
        | GP Trading Partner Code                   | REQUIRED   | n/a      |
        | Destinaton HA Cipher                      | REQUIRED   | n/a      |
        | NHS Number                                | REQUIRED   | n/a      |
        | New Surname                               | OPTIONAL   | NO       |
        | New Previous Surname                      | OPTIONAL   | YES      |
        | New First Forename                        | OPTIONAL   | YES (1)  |
        | New Second Forename                       | OPTIONAL   | YES (1)  |
        | New Other Forenames                       | OPTIONAL   | YES (1)  |
        | New Title                                 | OPTIONAL   | YES      |
        | New Sex                                   | OPTIONAL   | NO       |
        | New Date of Birth                         | OPTIONAL   | NO       |
        | New Address - House Name                  | OPTIONAL   | YES      |
        | New Address - Number/Road Name            | OPTIONAL   | YES      |
        | New Address - Locality                    | OPTIONAL   | YES      |
        | New Address - Post Town                   | OPTIONAL   | NO       |
        | New Address - County                      | OPTIONAL   | YES      |
        | New Address - Postcode                    | OPTIONAL   | YES      |
        | New Drugs Dispensed Marker                | OPTIONAL   | YES (2)  |
        | New RPP Mileage                           | DEPRECATED | n/a      |
        | New Blocked Route/Special District Marker | DEPRECATED | n/a      |
        | New Walking Units                         | DEPRECATED | n/a      |
        | New Residential Institute Code            | OPTIONAL   | YES (3)  |
        | GP Notes                                  | OPTIONAL   | n/a      |

        (1) Forenames cannot be erased individually. The entire group of forenames must be erased instead.

        (2) The Drugs Dispensed Marker is "erased" by settings its value to false

        (3) The Residential Institute Code is "erased" by using an add/replace operation with "valueString" JSON value of null

        ## FHIR / JSONPatch Field Mappings

        | Data Item                             | Property Name        | JSONPatch "path" value                   | "value" format, if different from GP Links | Notes                                                  |
        |---------------------------------------|----------------------|------------------------------------------|--------------------------------------------|--------------------------------------------------------|
        | Transaction Type                      | n/a                  | n/a                                      | n/a                                        | Determined by REST API method                          |
        | Existing GP Code                      | gpCode               |                                          |                                            |                                                        |
        | GP Trading Partner Code               | gpTradingPartnerCode |                                          |                                            |                                                        |
        | Destinaton HA Cipher                  | destinationHaCipher  |                                          |                                            |                                                        |
        | NHS Number                            | nhsNumber            |                                          |                                            |                                                        |
        | New Surname                           |                      | /name/0/family                           |                                            |                                                        |
        | New Previous Surname                  |                      | /name/1/family                           |                                            |                                                        |
        | New First Forename                    |                      | /name/0/given/0 For remove: name/0/given |                                            | Forenames cannot be erased individually                |
        | New Second Forename                   |                      | /name/0/given/1 For remove: name/0/given |                                            | Forenames cannot be erased individually                |
        | New Other Forenames                   |                      | /name/0/given/2 For remove: name/0/given |                                            | Forenames cannot be erased individually                |
        | New Title                             |                      | /name/0/prefix/0                         |                                            |                                                        |
        | New Sex                               |                      | /gender                                  | male/female/unknown/other                  |                                                        |
        | New Date of Birth                     |                      | /birthDate                               | ISO 8601 Date                              |                                                        |
        | New Address - House Name              |                      | /address/0/line/0                        | Use JSON null for empty/no value           | If address is changed then all 5 lines are required    |
        | New Address - Number/Road Name        |                      | /address/0/line/1                        | Use JSON null for empty/no value           | If address is changed then all 5 lines are required    |
        | New Address - Locality                |                      | /address/0/line/2                        | Use JSON null for empty/no value           | If address is changed then all 5 lines are required    |
        | New Address - Post Town               |                      | /address/0/line/3                        | Use JSON null for empty/no value           | If address is changed then all 5 lines are required    |
        | New Address - County                  |                      | /address/0/line/4                        | Use JSON null for empty/no value           | If address is changed then all 5 lines are required    |
        | New Address - Postcode                |                      | /address/0/postalCode                    |                                            |                                                        |
        | Drugs Dispensed Marker                |                      | /extension/0                             | (1)                                        | The value 'false' erases the Drugs Dispensed Marker    |
        | RPP Mileage                           | N/A                  |                                          |                                            |                                                        |
        | Blocked Route/Special District Marker | N/A                  |                                          |                                            |                                                        |
        | Walking Units                         | N/A                  |                                          |                                            |                                                        |
        | Residential Institute Code            |                      | /extension/0                             | (2)                                        | The value 'null' erases the Residential Institude Code |
        | GP Notes                              | freeText             |                                          |                                            |                                                        |

        (1) The `value` of the patch must be the entire extension including `url` and `valueBoolean` properties.

        (2) The `value` of the patch must be the entire extension including `url` and `valueString` properties.

        ## Operation Id

        An amendment request will produce an operation id in the response headers. This operation id MUST be retained
        to match against the asynchronous reply from NHAIS

      summary: Amend patient details (Amendment transaction)
      operationId: amendment
      tags:
        - patients
      externalDocs:
        description: IETF RFC 6902, which defines json-patch.
        url: https://tools.ietf.org/html/rfc6902
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: components/schemas/Amendment.yaml
      responses:
        '202':
          description: Amendment forwarded to NHAIS for processing
          headers:
            operationid:
              schema:
                type: string
              description: The unique identifier for the operation MUST be retained to match to the inbound reply
        '400':
          description: Client error.
          content:
            application/fhir+json:
              schema:
                $ref: components/schemas/OperationOutcome.yaml
components:
  parameters:
    Id:
      name: id
      in: path
      description: The patient's NHS Number. The primary identifier of a patient, unique within NHS England and Wales. Always 10 digits and must be a [valid NHS Number](https://www.datadictionary.nhs.uk/data_dictionary/attributes/n/nhs/nhs_number_de.asp).
      required: true
      schema:
        type: string
        example: "9000000009"
